<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Kitchen Dashboard | Prince Fast Foods</title>
    <style>
        /* üõ†Ô∏è FORCE OVERRIDE STYLES */
        :root {
            --bg-color: #fcfaf5 !important; /* Subtle Cream */
            --card-bg: #ffffff !important;
            --text-color: #2c3e50 !important;
            --ticket-bg: #f8f9fa !important;
            --accent: #ffc107 !important;
        }

        [data-bs-theme="dark"] {
            --bg-color: #121212 !important;
            --card-bg: #1e1e1e !important;
            --text-color: #e0e0e0 !important;
            --ticket-bg: #2d2d2d !important;
        }

        body {
            background-color: var(--bg-color) !important;
            font-family: 'Poppins', sans-serif;
            color: var(--text-color) !important;
            transition: all 0.3s ease;
            margin: 0; padding: 0;
        }

        /* üìä REVENUE CHART - MUST BE VISIBLE */
        .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 120px;
            padding: 10px 0;
            background: transparent;
        }
        .bar-group { text-align: center; flex: 1; }
        .bar {
            width: 70%;
            margin: 0 auto;
            background: var(--accent) !important;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            min-height: 8px; /* Force visibility even at 0 */
        }
        .bar-label { font-size: 0.7rem; margin-top: 5px; font-weight: 600; }

        /* üåô TOGGLE BUTTON */
        .dark-mode-toggle {
            cursor: pointer;
            font-size: 1.6rem;
            padding: 8px;
            border-radius: 50%;
            background: rgba(0,0,0,0.05);
            line-height: 1;
            transition: 0.3s;
        }
        [data-bs-theme="dark"] .dark-mode-toggle { background: rgba(255,255,255,0.1); }

        .card { 
            background-color: var(--card-bg) !important;
            border: none !important;
            border-radius: 15px !important; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05) !important;
        }
        
        .stats-card { border-left: 6px solid var(--accent) !important; }
        .table-dark { background-color: #212529 !important; }
        
        .order-instructions {
            background-color: var(--ticket-bg) !important;
            border: 1px dashed #dee2e6;
        }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
    <audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4 no-print border-bottom pb-3">
            <div>
                <h2 class="fw-bold mb-0">üëë Prince <span style="color: #ffc107;">Kitchen</span></h2>
                <p class="text-muted small mb-0">Logged in as Administrator</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="dark-mode-toggle no-print" onclick="toggleDarkMode()" id="modeBtn">üåô</div>
                <a href="/" class="btn btn-outline-dark btn-sm px-3">üè† Home</a>
                <a href="/logout" class="btn btn-danger btn-sm px-3">üîí Logout</a>
            </div>
        </div>

        <div class="card mb-4 no-print">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-3">üìà 7-Day Revenue Trends</h5>
                <div class="chart-container">
                    {% set days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                    {% for i in range(7) %}
                    <div class="bar-group">
                        {% set val = weekly_stats[i] if weekly_stats else 0 %}
                        <div class="bar" style="height: {{ (val / 50) if val > 0 else 5 }}px;" title="Ksh {{ val }}"></div>
                        <div class="bar-label">{{ days[i] }}</div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3 small border-top pt-2 d-flex justify-content-between">
                    <span>Total This Week: <strong>Ksh {{ weekly_total|default('0') }}</strong></span>
                    <span style="color: #e67e22;">Daily Target: Ksh 5,000</span>
                </div>
            </div>
        </div>

        <div class="row mb-4 no-print g-3">
            <div class="col-md-4">
                <div class="card stats-card p-3 h-100">
                    <h6 class="text-muted small fw-bold text-uppercase">Pending Orders</h6>
                    <h2 class="mb-0 fw-bold">{{ orders|length }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card p-3 h-100" style="border-left-color: #198754 !important;">
                    <h6 class="text-muted small fw-bold text-uppercase">Today's Sales</h6>
                    <h2 class="mb-0 text-success fw-bold">Ksh {{ daily_total }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card p-3 h-100" style="border-left-color: #0d6efd !important;">
                    <h6 class="text-muted small fw-bold text-uppercase">Status</h6>
                    <h2 class="mb-0 text-primary fw-bold">ONLINE</h2>
                </div>
            </div>
        </div>

        <div class="card mb-5 no-print border-0">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-4">üì¶ Stock & Inventory</h5>
                <form action="/admin/update_stock" method="POST" class="row g-3 mb-4">
                    <div class="col-md-5">
                        <select name="item_name" class="form-select" required>
                            <option value="" disabled selected>Select Item...</option>
                            <option value="Soft Chapati">Soft Chapati</option>
                            <option value="Classic Chips">Classic Chips</option>
                            <option value="Swahili Pilau">Swahili Pilau</option>
                            <option value="Fresh Mango (500ml)">Fresh Mango (500ml)</option>
                            <option value="Passion Fruit (500ml)">Passion Fruit (500ml)</option>
                            <option value="Pineapple Juice (500ml)">Pineapple Juice (500ml)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" name="new_count" class="form-control" placeholder="Qty" required>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-warning w-100 fw-bold">UPDATE</button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Item</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory %}
                            <tr>
                                <td class="fw-bold">{{ item[0] }}</td>
                                <td>Ksh {{ item[2] }}</td>
                                <td>{{ item[1] }}</td>
                                <td>
                                    {% if item[1] <= 0 %}
                                        <span class="badge bg-danger">SOLD OUT</span>
                                    {% elif item[1] < 10 %}
                                        <span class="badge bg-warning text-dark">LOW</span>
                                    {% else %}
                                        <span class="badge bg-success">OK</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h4 class="fw-bold mb-4 no-print">üìã Kitchen Tickets</h4>
        <div class="row">
            {% for order in orders %}
            <div class="col-12 mb-4">
                <div class="card border-0" id="order-{{ order[0] }}">
                    <div class="card-body p-4">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                            <div>
                                <h5 class="card-title mb-0">Order #{{ order[0] }}</h5>
                                <small class="text-muted">{{ order[4] }}</small>
                            </div>
                            <div class="no-print d-flex gap-2">
                                <button onclick="printOrder('order-{{ order[0] }}')" class="btn btn-dark btn-sm px-3">üñ®Ô∏è Ticket</button>
                                <form action="/complete/{{ order[0] }}" method="POST" class="d-flex gap-1">
                                    <input type="number" name="amount" class="form-control" style="width:110px" placeholder="Ksh" required>
                                    <button type="submit" class="btn btn-success">‚úÖ COMPLETE</button>
                                </form>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-1 text-muted small fw-bold">CUSTOMER</p>
                                <p class="mb-0 fw-bold">{{ order[1] }}</p>
                                <p class="text-muted small">{{ order[2] }}</p>
                            </div>
                            <div class="col-md-8">
                                <p class="mb-1 text-muted small fw-bold">INSTRUCTIONS</p>
                                <div class="p-3 rounded order-instructions">
                                    <p class="mb-0 fs-5" style="white-space: pre-line;">{{ order[3] }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        // üåì DARK MODE LOGIC
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-bs-theme') === 'dark';
            const newMode = isDark ? 'light' : 'dark';
            
            html.setAttribute('data-bs-theme', newMode);
            document.getElementById('modeBtn').innerText = newMode === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('prince_theme', newMode);
        }

        // LOAD SAVED THEME
        const savedTheme = localStorage.getItem('prince_theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
        document.getElementById('modeBtn').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        // üîî NOTIFICATION SOUND
        const currentCount = {{ orders|length }};
        const lastCount = localStorage.getItem('lastCount') || 0;
        if (currentCount > lastCount) {
            document.getElementById('orderSound').play().catch(e => console.log("Waiting for user click..."));
        }
        localStorage.setItem('lastCount', currentCount);

        // AUTO REFRESH
        setTimeout(() => location.reload(), 30000);

        function printOrder(id) {
            const content = document.getElementById(id).innerHTML;
            const win = window.open('', '', 'height=700,width=700');
            win.document.write('<html><head><title>Kitchen Ticket</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></head><body>');
            win.document.write('<div style="padding:30px"><h2>üëë PRINCE FAST FOODS</h2><hr>' + content + '</div></body></html>');
            win.document.close();
            setTimeout(() => { win.print(); win.close(); }, 500);
        }
    </script>
</body>
</html>